# 臨時用戶功能說明

## 🎯 功能概述

當用戶向未註冊的車牌發送提醒時，系統會自動為該車牌創建一個臨時用戶記錄。當該車牌的真實用戶註冊時，系統會自動將臨時用戶的數據（消息、點數等）合併到真實用戶帳戶中。

## 🔄 工作流程

### 1. 發送消息到未註冊車牌

**場景**：用戶 A 向車牌 "ABC-1234" 發送提醒，但該車牌尚未註冊。

**系統行為**：
- 自動創建臨時用戶記錄
- 臨時用戶的 `phone` 設為：`temp_ABC-1234_<timestamp>`
- 臨時用戶的 `licensePlate` 設為：`ABC-1234`
- 臨時用戶的 `userType` 設為：`driver`
- 臨時用戶的 `hasCompletedOnboarding` 設為：`false`
- 消息正常發送到臨時用戶

### 2. 真實用戶註冊

**場景**：車牌 "ABC-1234" 的真實用戶完成註冊流程。

**系統行為**：
1. 在 `completeOnboarding` 時，系統檢查是否有該車牌的臨時用戶
2. 如果找到臨時用戶：
   - 將臨時用戶收到的所有消息轉移到真實用戶
   - 將臨時用戶的點數轉移到真實用戶
   - 更新真實用戶的車牌信息
   - 刪除臨時用戶記錄
3. 如果沒有臨時用戶，正常完成註冊

## 📋 實現細節

### 臨時用戶標識

- **Phone 格式**：`temp_<車牌>_<時間戳>`
- **示例**：`temp_ABC-1234_1705670400000`
- **特徵**：`phone.startsWith('temp_')`

### 數據合併邏輯

當真實用戶註冊時，系統會：

1. **消息轉移**：
   ```typescript
   await this.prisma.message.updateMany({
     where: { receiverId: tempUser.id },
     data: { receiverId: userId },
   });
   ```

2. **點數轉移**：
   ```typescript
   await this.prisma.pointHistory.create({
     data: {
       userId: userId,
       type: 'bonus',
       amount: tempUser.points,
       description: '從臨時帳戶轉移的點數',
     },
   });
   ```

3. **刪除臨時用戶**：
   ```typescript
   await this.prisma.user.delete({
     where: { id: tempUser.id },
   });
   ```

## 🎨 用戶體驗

### 發送者視角

- ✅ 可以隨時向任何車牌發送提醒
- ✅ 不需要等待對方註冊
- ✅ 消息會正常發送，不會返回 404 錯誤

### 接收者視角

- ✅ 註冊後自動收到之前發送給該車牌的所有消息
- ✅ 不會錯過任何提醒
- ✅ 點數會自動合併

## 🔍 技術實現

### 修改的文件

1. **`backend/src/messages/messages.service.ts`**
   - 在 `create` 方法中，如果找不到用戶，創建臨時用戶

2. **`backend/src/users/users.service.ts`**
   - 在 `completeOnboarding` 方法中，檢查並合併臨時用戶數據

### 數據庫設計

- 臨時用戶使用標準 `User` 模型
- 通過 `phone` 字段前綴 `temp_` 來識別
- 所有關聯數據（消息、點數等）正常存儲

## ⚠️ 注意事項

1. **臨時用戶清理**：
   - 目前沒有自動清理機制
   - 如果臨時用戶一直沒有真實用戶註冊，會一直存在
   - 可以考慮添加定期清理任務（例如：30天未激活的臨時用戶）

2. **車牌唯一性**：
   - 如果多個臨時用戶使用相同車牌，只有第一個會被合併
   - 建議在創建臨時用戶時檢查是否已存在

3. **點數處理**：
   - 臨時用戶的點數會轉移到真實用戶
   - 如果臨時用戶收到讚美（獲得點數），這些點數也會轉移

## 🚀 未來改進

1. **自動清理**：定期清理長期未激活的臨時用戶
2. **通知機制**：當臨時用戶收到消息時，可以發送通知（如果可能）
3. **統計分析**：追蹤臨時用戶轉化率
