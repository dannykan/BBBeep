// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// Seed configuration
// Run: npm run prisma:seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  driver
  pedestrian
}

enum VehicleType {
  car
  scooter
}

enum MessageType {
  VEHICLE_REMINDER // 車況提醒
  SAFETY_REMINDER // 行車安全提醒
  PRAISE // 讚美感謝
}

enum PointHistoryType {
  recharge
  spend
  earn
  bonus
}

enum InviteStatus {
  pending   // 邀請碼已輸入，onboarding 未完成
  completed // onboarding 完成，獎勵已發放
  expired   // 用戶放棄註冊
}

enum ApplicationStatus {
  pending // 待審核
  approved // 已通過
  rejected // 已拒絕
}

enum ReportStatus {
  pending // 待審核
  reviewed // 已審核
  resolved // 已處理
}

model User {
  id                     String       @id @default(cuid())
  phone                  String?      @unique // 改為可選，支援 LINE 登入用戶
  password               String? // 密碼（可選，用於已註冊用戶）
  nickname               String?
  licensePlate           String?
  userType               UserType
  vehicleType            VehicleType?
  points                 Int          @default(0)  // 購買的點數（不會每日重置）
  freePoints             Int          @default(2)  // 每日免費點數（每日重置為2）
  lastFreePointsReset    DateTime?                 // 上次免費點數重置時間（台北時間）
  hasCompletedOnboarding Boolean      @default(false)
  email                  String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  // LINE Login 相關欄位
  lineUserId             String?      @unique // LINE User ID
  lineDisplayName        String?              // LINE 顯示名稱
  linePictureUrl         String?              // LINE 頭像 URL

  // 官方封鎖相關欄位
  isBlockedByAdmin       Boolean      @default(false) // 是否被官方封鎖
  blockedByAdminAt       DateTime?                    // 封鎖時間
  blockedByAdminReason   String?                      // 封鎖原因

  // 邀請碼相關
  inviteCode             String?      @unique        // 用戶的個人邀請碼
  invitedById            String?                     // 邀請此用戶的人的 ID
  invitedBy              User?        @relation("Inviter", fields: [invitedById], references: [id])
  invitedUsers           User[]       @relation("Inviter")
  customInviterReward    Int?                        // 此用戶的邀請碼給邀請人的獎勵（覆蓋預設）
  customInviteeReward    Int?                        // 此用戶的邀請碼給被邀請人的獎勵（覆蓋預設）

  // Relations
  sentMessages             Message[]                 @relation("Sender")
  receivedMessages         Message[]                 @relation("Receiver")
  pointHistory             PointHistory[]
  blockedUsers             BlockedUser[]             @relation("Blocker")
  blockedByUsers           BlockedUser[]             @relation("Blocked")
  rejectedUsers            RejectedUser[]            @relation("Rejecter")
  rejectedByUsers          RejectedUser[]            @relation("Rejected")
  messageReports           MessageReport[]           @relation("Reporter")
  aiUsageLogs              AIUsageLog[]
  licensePlateApplications LicensePlateApplication[]
  inviteHistoryAsInviter   InviteHistory[]           @relation("InviterHistory")
  inviteHistoryAsInvitee   InviteHistory?            @relation("InviteeHistory")

  @@index([phone])
  @@index([licensePlate])
  @@index([lineUserId])
}

model Message {
  id         String      @id @default(cuid())
  type       MessageType
  template   String
  customText String?
  replyText  String? // 接收者回覆內容（僅供記錄，不會通知發送者）
  location   String?     // 事發地點（地址或描述）
  occurredAt DateTime?   // 事發時間
  read       Boolean     @default(false)
  createdAt  DateTime    @default(now())

  // Relations
  senderId   String
  sender     User            @relation("Sender", fields: [senderId], references: [id])
  receiverId String
  receiver   User            @relation("Receiver", fields: [receiverId], references: [id])
  reports    MessageReport[] // 檢舉記錄

  @@index([receiverId, createdAt])
  @@index([senderId])
}

model PointHistory {
  id          String           @id @default(cuid())
  type        PointHistoryType
  amount      Int
  description String
  createdAt   DateTime         @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model BlockedUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  blockerId String
  blocker   User   @relation("Blocker", fields: [blockerId], references: [id])
  blockedId String
  blocked   User   @relation("Blocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model RejectedUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  rejecterId String
  rejecter   User   @relation("Rejecter", fields: [rejecterId], references: [id])
  rejectedId String
  rejected   User   @relation("Rejected", fields: [rejectedId], references: [id])

  @@unique([rejecterId, rejectedId])
  @@index([rejecterId])
  @@index([rejectedId])
}

model AIUsageLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  usedAt    DateTime @default(now())
  resetDate DateTime // 用於追蹤每日重置

  @@index([userId, resetDate])
  @@index([resetDate])
}

model LicensePlateApplication {
  id           String            @id @default(cuid())
  userId       String
  user         User              @relation(fields: [userId], references: [id])
  licensePlate String
  vehicleType  VehicleType?
  status       ApplicationStatus @default(pending)
  licenseImage String? // 行照照片 URL
  email        String? // 申請人 Email（用於通知審核結果）
  adminNote    String? // 管理員備註
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  reviewedAt   DateTime?
  reviewedBy   String? // 審核管理員 ID

  @@index([userId])
  @@index([licensePlate])
  @@index([status])
}

model MessageReport {
  id         String       @id @default(cuid())
  messageId  String
  message    Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User         @relation("Reporter", fields: [reporterId], references: [id])
  reason     String? // 檢舉原因
  status     ReportStatus @default(pending)
  adminNote  String? // 管理員備註
  createdAt  DateTime     @default(now())
  reviewedAt DateTime?
  reviewedBy String? // 審核管理員 ID

  @@unique([messageId, reporterId]) // 同一用戶對同一訊息只能檢舉一次
  @@index([messageId])
  @@index([reporterId])
  @@index([status])
}

model AIPrompt {
  id          String      @id @default(cuid())
  vehicleType VehicleType // car | scooter
  category    String // '車況提醒' | '行車安全' | '讚美感謝' | '其他情況'
  prompt      String // Prompt 模板，可以使用 {text} 占位符
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([vehicleType, category])
  @@index([vehicleType, category, isActive])
}

model InviteSettings {
  id                   String   @id @default(cuid())
  defaultInviterReward Int      @default(5)    // 邀請人獎勵點數
  defaultInviteeReward Int      @default(3)    // 被邀請人獎勵點數
  isEnabled            Boolean  @default(true) // 啟用/停用邀請系統
  updatedAt            DateTime @updatedAt
}

model InviteHistory {
  id            String       @id @default(cuid())
  inviterId     String
  inviter       User         @relation("InviterHistory", fields: [inviterId], references: [id])
  inviteeId     String       @unique  // 每個用戶只能被邀請一次
  invitee       User         @relation("InviteeHistory", fields: [inviteeId], references: [id])
  inviteCode    String       // 使用的邀請碼
  status        InviteStatus @default(pending)
  inviterReward Int          // 實際給邀請人的獎勵
  inviteeReward Int          // 實際給被邀請人的獎勵
  rewardedAt    DateTime?    // 獎勵發放時間
  createdAt     DateTime     @default(now())

  @@index([inviterId])
  @@index([status])
  @@index([createdAt])
}
