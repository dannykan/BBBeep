/**
 * Onboarding Screen
 * é¦–æ¬¡ç™»å…¥è¨­å®šé é¢ - å°é½Š Web ç‰ˆæœ¬è¨­è¨ˆï¼ˆ6 æ­¥é©Ÿæµç¨‹ï¼‰
 * æ­¥é©Ÿé †åºï¼šèº«ä»½é¸æ“‡ â†’ è»Šç‰Œ(é§•é§›) â†’ æš±ç¨± â†’ é»æ•¸èªªæ˜ â†’ é‚€è«‹ç¢¼ â†’ æ­¡è¿
 */

import React, { useState, useCallback, useMemo, useRef } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  Modal,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator,
  PanResponder,
  GestureResponderEvent,
  PanResponderGestureState,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { Ionicons } from '@expo/vector-icons';
import { useAuth } from '../context/AuthContext';
import {
  usersApi,
  inviteApi,
  licensePlateApi,
  normalizeLicensePlate,
  displayLicensePlate,
} from '@bbbeeep/shared';
import type {
  UserType,
  VehicleType,
  ValidateCodeResponse,
  LicensePlateCheckResponse,
} from '@bbbeeep/shared';
import {
  colors,
  typography,
  spacing,
  borderRadius,
} from '../theme';

type OnboardingStep = 1 | 2 | 3 | 4 | 5 | 6;

export default function OnboardingScreen() {
  const { refreshUser } = useAuth();
  const [step, setStep] = useState<OnboardingStep>(1);
  const [userType, setUserType] = useState<UserType | null>(null);
  const [vehicleType, setVehicleType] = useState<VehicleType | null>(null);
  const [nickname, setNickname] = useState('');
  const [licensePlate, setLicensePlate] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  // Invite code state
  const [inviteCode, setInviteCode] = useState('');
  const [inviteCodeValidation, setInviteCodeValidation] = useState<ValidateCodeResponse | null>(null);
  const [isValidatingCode, setIsValidatingCode] = useState(false);
  const [inviteCodeApplied, setInviteCodeApplied] = useState(false);

  // License plate state
  const [showLicensePlateDialog, setShowLicensePlateDialog] = useState(false);
  const [licensePlateCheckResult, setLicensePlateCheckResult] = useState<LicensePlateCheckResponse | null>(null);
  const [showApplicationDialog, setShowApplicationDialog] = useState(false);
  const [applicationEmail, setApplicationEmail] = useState('');

  // Calculate steps - memoized to prevent recalculation
  const { totalSteps, currentDisplayStep } = useMemo(() => {
    const total = userType === 'pedestrian' ? 5 : 6;
    let display = step;
    if (userType === 'pedestrian') {
      // Pedestrians skip step 2 (license plate), so steps 3-6 display as 2-5
      if (step >= 3) display = step - 1;
    }
    return { totalSteps: total, currentDisplayStep: display };
  }, [step, userType]);

  // Simple back handler - no async operations
  const handleBack = useCallback(() => {
    switch (step) {
      case 2:
        setStep(1);
        break;
      case 3:
        setStep(userType === 'pedestrian' ? 1 : 2);
        break;
      case 4:
        setStep(3);
        break;
      case 5:
        setStep(4);
        break;
      case 6:
        setStep(5);
        break;
    }
  }, [step, userType]);

  // Step 1: User type selection
  const handleUserTypeSelect = useCallback((type: UserType, vehicle?: VehicleType) => {
    setUserType(type);
    if (vehicle) setVehicleType(vehicle);
    // Pedestrians skip license plate step
    setStep(type === 'pedestrian' ? 3 : 2);
  }, []);

  // Step 2: License plate submit
  const handleLicensePlateSubmit = useCallback(async () => {
    if (!licensePlate) return;

    const normalizedPlate = normalizeLicensePlate(licensePlate);
    if (!normalizedPlate) {
      Alert.alert('éŒ¯èª¤', 'è»Šç‰Œè™Ÿç¢¼æ ¼å¼ç„¡æ•ˆ');
      return;
    }

    setIsLoading(true);
    try {
      const checkResult = await licensePlateApi.checkAvailability(normalizedPlate);
      if (checkResult.isBound) {
        setLicensePlateCheckResult(checkResult);
        setShowLicensePlateDialog(true);
      } else {
        setStep(3); // Go to nickname
      }
    } catch (error: any) {
      Alert.alert('éŒ¯èª¤', error.response?.data?.message || 'æª¢æŸ¥è»Šç‰Œå¤±æ•—');
    } finally {
      setIsLoading(false);
    }
  }, [licensePlate]);

  // License plate application handlers
  const handleConfirmApplication = useCallback(() => {
    setShowLicensePlateDialog(false);
    setShowApplicationDialog(true);
  }, []);

  const handleSubmitApplication = useCallback(async () => {
    if (!licensePlate) return;

    const normalizedPlate = normalizeLicensePlate(licensePlate);
    if (!normalizedPlate) {
      Alert.alert('éŒ¯èª¤', 'è»Šç‰Œè™Ÿç¢¼æ ¼å¼ç„¡æ•ˆ');
      return;
    }

    setIsLoading(true);
    try {
      await licensePlateApi.createApplication({
        licensePlate: normalizedPlate,
        vehicleType: vehicleType || undefined,
        email: applicationEmail || undefined,
      });
      Alert.alert('æˆåŠŸ', 'ç”³è«‹å·²æäº¤ï¼Œæˆ‘å€‘æœƒåœ¨ 1-2 å€‹å·¥ä½œå¤©å…§ä»¥ Email é€šçŸ¥');
      setShowApplicationDialog(false);
      setStep(3); // Go to nickname
    } catch (error: any) {
      Alert.alert('éŒ¯èª¤', error.response?.data?.message || 'æäº¤ç”³è«‹å¤±æ•—');
    } finally {
      setIsLoading(false);
    }
  }, [licensePlate, vehicleType, applicationEmail]);

  // Step 3: Nickname submit
  const handleNicknameSubmit = useCallback(() => {
    setStep(4); // Go to points explanation - no async needed here
  }, []);

  // Step 4: Points explanation next
  const handlePointsNext = useCallback(() => {
    setStep(5); // Go to invite code
  }, []);

  // Step 5: Invite code
  const handleValidateInviteCode = useCallback(async (code: string) => {
    if (code.length !== 6) {
      setInviteCodeValidation(null);
      return;
    }

    setIsValidatingCode(true);
    try {
      const result = await inviteApi.validateCode(code);
      setInviteCodeValidation(result);
    } catch (error) {
      setInviteCodeValidation({ valid: false, message: 'é©—è­‰å¤±æ•—' });
    } finally {
      setIsValidatingCode(false);
    }
  }, []);

  const handleApplyInviteCode = useCallback(async () => {
    if (!inviteCodeValidation?.valid || !inviteCode) return;

    setIsLoading(true);
    try {
      await inviteApi.applyCode(inviteCode);
      setInviteCodeApplied(true);
      Alert.alert('æˆåŠŸ', 'é‚€è«‹ç¢¼å·²å¥—ç”¨ï¼å®Œæˆè¨»å†Šå¾Œä½ å’Œé‚€è«‹äººå„å¾— 10 é»');
      setStep(6);
    } catch (error: any) {
      Alert.alert('éŒ¯èª¤', error.response?.data?.message || 'ä½¿ç”¨é‚€è«‹ç¢¼å¤±æ•—');
    } finally {
      setIsLoading(false);
    }
  }, [inviteCodeValidation, inviteCode]);

  const handleSkipInviteCode = useCallback(() => {
    setStep(6);
  }, []);

  // Step 6: Complete onboarding
  const handleCompleteOnboarding = useCallback(async () => {
    if (!userType) return;

    const normalizedPlate = licensePlate ? normalizeLicensePlate(licensePlate) : undefined;
    if (licensePlate && !normalizedPlate) {
      Alert.alert('éŒ¯èª¤', 'è»Šç‰Œè™Ÿç¢¼æ ¼å¼ç„¡æ•ˆ');
      return;
    }

    setIsLoading(true);
    try {
      await usersApi.completeOnboarding({
        userType,
        vehicleType: vehicleType || undefined,
        licensePlate: normalizedPlate || undefined,
        nickname: nickname || undefined,
      });
      await refreshUser();
    } catch (error: any) {
      Alert.alert('éŒ¯èª¤', error.response?.data?.message || 'å®Œæˆè¨»å†Šå¤±æ•—');
    } finally {
      setIsLoading(false);
    }
  }, [userType, vehicleType, licensePlate, nickname, refreshUser]);

  // Invite code input handler
  const handleInviteCodeChange = useCallback((text: string) => {
    const cleaned = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (cleaned.length <= 6) {
      setInviteCode(cleaned);
      if (cleaned.length === 6) {
        handleValidateInviteCode(cleaned);
      } else {
        setInviteCodeValidation(null);
      }
    }
  }, [handleValidateInviteCode]);

  // License plate input handler
  const handleLicensePlateChange = useCallback((text: string) => {
    const cleaned = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
    setLicensePlate(cleaned);
  }, []);

  // Swipe gesture for back navigation
  const swipeStartX = useRef(0);
  const panResponder = useMemo(() => {
    return PanResponder.create({
      onStartShouldSetPanResponder: () => false,
      onMoveShouldSetPanResponder: (
        _evt: GestureResponderEvent,
        gestureState: PanResponderGestureState
      ) => {
        // Only capture horizontal swipes starting from the left edge (first 50px)
        const isHorizontalSwipe = Math.abs(gestureState.dx) > Math.abs(gestureState.dy);
        const isSwipingRight = gestureState.dx > 0;
        const startedFromLeftEdge = swipeStartX.current < 50;
        return isHorizontalSwipe && isSwipingRight && startedFromLeftEdge && step > 1;
      },
      onPanResponderGrant: (evt: GestureResponderEvent) => {
        swipeStartX.current = evt.nativeEvent.pageX;
      },
      onPanResponderRelease: (
        _evt: GestureResponderEvent,
        gestureState: PanResponderGestureState
      ) => {
        // Trigger back if swiped more than 100px to the right
        if (gestureState.dx > 100 && step > 1) {
          handleBack();
        }
      },
    });
  }, [step, handleBack]);

  return (
    <View style={styles.container} {...panResponder.panHandlers}>
      {/* Header - çµ±ä¸€æ ¼å¼ï¼ˆå›ºå®šé«˜åº¦ï¼‰ */}
      <View style={styles.headerContainer}>
        <SafeAreaView edges={['top']} style={styles.headerSafeArea}>
          <View style={styles.header}>
            <View style={styles.headerLeft}>
              {step > 1 ? (
                <TouchableOpacity
                  style={styles.backButton}
                  onPress={handleBack}
                  hitSlop={{ top: 12, bottom: 12, left: 12, right: 12 }}
                  activeOpacity={0.6}
                >
                  <Ionicons name="chevron-back" size={20} color={colors.muted.foreground} />
                  <Text style={styles.backText}>è¿”å›</Text>
                </TouchableOpacity>
              ) : null}
            </View>
            <Text style={styles.headerTitle}>
              è¨»å†Šæµç¨‹ ({currentDisplayStep}/{totalSteps})
            </Text>
            <View style={styles.headerRight} />
          </View>
        </SafeAreaView>
      </View>

      <KeyboardAvoidingView
        style={styles.flex1}
        behavior={Platform.OS === 'ios' ? 'padding' : undefined}
      >
        <ScrollView
          style={styles.scrollView}
          contentContainerStyle={styles.scrollContent}
          showsVerticalScrollIndicator={false}
          keyboardShouldPersistTaps="handled"
        >
          {/* Progress Indicator */}
          <View style={styles.progressContainer}>
            {Array.from({ length: totalSteps }, (_, i) => i + 1).map((s) => (
              <View
                key={s}
                style={[
                  styles.progressDot,
                  s === currentDisplayStep && styles.progressDotActive,
                  s < currentDisplayStep && styles.progressDotCompleted,
                ]}
              />
            ))}
          </View>

          {/* Step 1: User Type Selection */}
          {step === 1 && (
            <View style={styles.stepContent}>
              <View style={styles.stepHeader}>
                <Text style={styles.stepTitle}>ä½ ä»Šå¤©æ˜¯ç”¨ä»€éº¼æ–¹å¼åœ¨è·¯ä¸Šï¼Ÿ</Text>
                <Text style={styles.stepSubtitle}>ä¸åŒèº«åˆ†ï¼Œèƒ½ä½¿ç”¨çš„åŠŸèƒ½æœƒä¸ä¸€æ¨£</Text>
              </View>

              <View style={styles.userTypeOptions}>
                <TouchableOpacity
                  style={styles.userTypeOption}
                  onPress={() => handleUserTypeSelect('driver', 'car')}
                  activeOpacity={0.7}
                >
                  <View style={styles.userTypeContent}>
                    <Ionicons name="car-outline" size={32} color={colors.primary.DEFAULT} />
                    <View style={styles.userTypeTextContainer}>
                      <Text style={styles.userTypeTitle}>æ±½è»Šé§•é§›</Text>
                      <Text style={styles.userTypeDescription}>
                        å¡«å¯«è»Šç‰Œï½œå¯ä»¥ç™¼é€ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶æé†’
                      </Text>
                    </View>
                  </View>
                </TouchableOpacity>

                <TouchableOpacity
                  style={styles.userTypeOption}
                  onPress={() => handleUserTypeSelect('driver', 'scooter')}
                  activeOpacity={0.7}
                >
                  <View style={styles.userTypeContent}>
                    <Ionicons name="bicycle-outline" size={32} color={colors.primary.DEFAULT} />
                    <View style={styles.userTypeTextContainer}>
                      <Text style={styles.userTypeTitle}>æ©Ÿè»Šé¨å£«</Text>
                      <Text style={styles.userTypeDescription}>
                        å¡«å¯«è»Šç‰Œï½œå¯ä»¥ç™¼é€ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶æé†’
                      </Text>
                    </View>
                  </View>
                </TouchableOpacity>

                <TouchableOpacity
                  style={styles.userTypeOption}
                  onPress={() => handleUserTypeSelect('pedestrian')}
                  activeOpacity={0.7}
                >
                  <View style={styles.userTypeContent}>
                    <Ionicons name="person-outline" size={32} color={colors.primary.DEFAULT} />
                    <View style={styles.userTypeTextContainer}>
                      <Text style={styles.userTypeTitle}>è¡Œäºº / è…³è¸è»Š</Text>
                      <Text style={styles.userTypeDescription}>
                        ä¸éœ€è»Šç‰Œï½œåªèƒ½ç™¼é€æé†’
                      </Text>
                    </View>
                  </View>
                </TouchableOpacity>
              </View>

              <View style={styles.infoCard}>
                <Text style={styles.infoText}>
                  ğŸ’¡ è¡Œäºº / è…³è¸è»Šæ²’æœ‰è»Šç‰Œï¼Œå› æ­¤ä¸æœƒæ”¶åˆ°åˆ¥äººçš„æé†’
                </Text>
              </View>
            </View>
          )}

          {/* Step 2: License Plate (Drivers only) */}
          {step === 2 && userType === 'driver' && (
            <View style={styles.card}>
              <View style={styles.stepHeader}>
                <View style={styles.vehicleTypeBadge}>
                  <Ionicons
                    name={vehicleType === 'car' ? 'car-outline' : 'bicycle-outline'}
                    size={20}
                    color={colors.primary.DEFAULT}
                  />
                  <Text style={styles.vehicleTypeBadgeText}>
                    {vehicleType === 'car' ? 'æ±½è»Šé§•é§›' : 'æ©Ÿè»Šé¨å£«'}
                  </Text>
                </View>
                <Text style={styles.stepTitle}>å¡«å¯«ä½ çš„è»Šç‰Œ</Text>
                <Text style={styles.stepSubtitle}>
                  åªç”¨ä¾†æ¥æ”¶æé†’{'\n'}ä¸æœƒå…¬é–‹ã€ä¸æœƒè¢«å…¶ä»–äººçœ‹åˆ°
                </Text>
              </View>

              <View style={styles.inputSection}>
                <Text style={styles.label}>
                  {vehicleType === 'car' ? 'æ±½è»Šè»Šç‰Œ' : 'æ©Ÿè»Šè»Šç‰Œ'}
                </Text>
                <TextInput
                  style={styles.licensePlateInput}
                  placeholder={vehicleType === 'car' ? 'ABC1234' : 'ABC123'}
                  placeholderTextColor={colors.muted.foreground}
                  value={licensePlate}
                  onChangeText={handleLicensePlateChange}
                  maxLength={8}
                  autoCapitalize="characters"
                />
                <Text style={styles.inputHintCenter}>
                  {vehicleType === 'car'
                    ? 'æ ¼å¼ç¯„ä¾‹ï¼šABC1234 æˆ– ABC-1234'
                    : 'æ ¼å¼ç¯„ä¾‹ï¼šABC123 æˆ– ABC-123'}
                </Text>
              </View>

              <TouchableOpacity
                style={[styles.primaryButton, styles.buttonMarginTop, !licensePlate && styles.buttonDisabled]}
                onPress={handleLicensePlateSubmit}
                disabled={!licensePlate || isLoading}
                activeOpacity={0.7}
              >
                {isLoading ? (
                  <ActivityIndicator color={colors.primary.foreground} />
                ) : (
                  <Text style={styles.primaryButtonText}>ä¸‹ä¸€æ­¥</Text>
                )}
              </TouchableOpacity>
            </View>
          )}

          {/* Step 3: Nickname */}
          {step === 3 && (
            <View style={styles.card}>
              <View style={styles.stepHeader}>
                <Text style={styles.stepTitle}>è¨­å®šä¸€å€‹æš±ç¨±ï¼ˆå¯è·³éï¼‰</Text>
                <Text style={styles.stepSubtitle}>
                  æš±ç¨±åªæœƒä»¥åŒ¿åæ–¹å¼é¡¯ç¤º{'\n'}ä¸è¨­å®šä¹Ÿèƒ½å®Œæ•´ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
                </Text>
              </View>

              <View style={styles.inputSection}>
                <Text style={styles.label}>æš±ç¨±</Text>
                <TextInput
                  style={styles.input}
                  placeholder="ä¾‹å¦‚ï¼šç†±å¿ƒé§•é§›ã€è·¯éæé†’ä¸€ä¸‹"
                  placeholderTextColor={colors.muted.foreground}
                  value={nickname}
                  onChangeText={setNickname}
                  maxLength={12}
                />
                <Text style={styles.inputHint}>æœ€å¤š 12 å€‹å­—</Text>
              </View>

              <View style={styles.buttonGroup}>
                <TouchableOpacity
                  style={styles.primaryButton}
                  onPress={handleNicknameSubmit}
                  activeOpacity={0.7}
                >
                  <Text style={styles.primaryButtonText}>
                    {nickname.trim() ? 'è¨­å®šæš±ç¨±ä¸¦ç¹¼çºŒ' : 'è·³é'}
                  </Text>
                </TouchableOpacity>
                {nickname.trim() !== '' && (
                  <TouchableOpacity
                    style={styles.textButton}
                    onPress={() => {
                      setNickname('');
                      handleNicknameSubmit();
                    }}
                    activeOpacity={0.7}
                  >
                    <Text style={styles.textButtonText}>è·³é</Text>
                  </TouchableOpacity>
                )}
              </View>
            </View>
          )}

          {/* Step 4: Points Explanation */}
          {step === 4 && (
            <View style={styles.card}>
              <View style={styles.stepHeader}>
                <Text style={styles.stepTitle}>
                  æ¯ä¸€æ¬¡æé†’{'\n'}éƒ½éœ€è¦ä¸€é»é»é»æ•¸
                </Text>
              </View>

              <View style={styles.pointsInfoList}>
                <View style={styles.pointsInfoItem}>
                  <Text style={styles.pointsInfoIcon}>ğŸ“©</Text>
                  <Text style={styles.pointsInfoText}>ç™¼é€æé†’æœƒæ¶ˆè€—é»æ•¸</Text>
                </View>
                <View style={styles.pointsInfoItem}>
                  <Text style={styles.pointsInfoIcon}>ğŸ‘</Text>
                  <Text style={styles.pointsInfoText}>æ”¶åˆ°è®šç¾ï¼Œå¯ä»¥ç²å¾—å°‘é‡é»æ•¸</Text>
                </View>
                <View style={styles.pointsInfoItem}>
                  <Text style={styles.pointsInfoIcon}>ğŸ”’</Text>
                  <Text style={styles.pointsInfoText}>è»Šç‰Œèˆ‡å€‹äººè³‡è¨Šéƒ½ä¸æœƒå…¬é–‹</Text>
                </View>
              </View>

              <View style={styles.bonusCard}>
                <Text style={styles.bonusCardText}>
                  ğŸ æ¯å¤©å…è²» 2 é»ï¼Œç”¨å®Œéš”å¤©è‡ªå‹•è£œæ»¿
                </Text>
              </View>

              <TouchableOpacity
                style={styles.primaryButton}
                onPress={handlePointsNext}
                activeOpacity={0.7}
              >
                <Text style={styles.primaryButtonText}>ä¸‹ä¸€æ­¥</Text>
              </TouchableOpacity>
            </View>
          )}

          {/* Step 5: Invite Code */}
          {step === 5 && (
            <View style={styles.card}>
              <View style={styles.stepHeader}>
                <View style={styles.iconCircle}>
                  <Ionicons name="gift-outline" size={28} color={colors.primary.DEFAULT} />
                </View>
                <Text style={styles.stepTitle}>æœ‰é‚€è«‹ç¢¼å—ï¼Ÿ</Text>
                <View style={styles.rewardBadge}>
                  <Text style={styles.rewardBadgeText}>è¼¸å…¥é‚€è«‹ç¢¼ï¼Œä½ æˆ‘å„å¾— 10 é»ï¼</Text>
                </View>
              </View>

              <View style={styles.inputSection}>
                <Text style={styles.label}>é‚€è«‹ç¢¼</Text>
                <TextInput
                  style={styles.inviteCodeInput}
                  placeholder="è¼¸å…¥ 6 ä½é‚€è«‹ç¢¼"
                  placeholderTextColor={colors.muted.foreground}
                  value={inviteCode}
                  onChangeText={handleInviteCodeChange}
                  maxLength={6}
                  autoCapitalize="characters"
                />

                {isValidatingCode && (
                  <Text style={styles.validatingText}>é©—è­‰ä¸­...</Text>
                )}

                {inviteCodeValidation?.valid && (
                  <View style={styles.validCodeCard}>
                    <View style={styles.validCodeIcon}>
                      <Ionicons name="checkmark" size={16} color="#16A34A" />
                    </View>
                    <View style={styles.validCodeContent}>
                      <Text style={styles.validCodeTitle}>
                        ä¾†è‡ªã€Œ{inviteCodeValidation.inviterNickname}ã€çš„é‚€è«‹
                      </Text>
                      <Text style={styles.validCodeSubtitle}>
                        å®Œæˆè¨»å†Šå¾Œï¼Œä½ å’Œé‚€è«‹äººå„å¾— 10 é»
                      </Text>
                    </View>
                  </View>
                )}

                {inviteCodeValidation && !inviteCodeValidation.valid && (
                  <Text style={styles.invalidCodeText}>
                    {inviteCodeValidation.message || 'ç„¡æ•ˆçš„é‚€è«‹ç¢¼'}
                  </Text>
                )}
              </View>

              <View style={styles.buttonGroup}>
                {inviteCodeValidation?.valid ? (
                  <>
                    <TouchableOpacity
                      style={[styles.primaryButton, isLoading && styles.buttonDisabled]}
                      onPress={handleApplyInviteCode}
                      disabled={isLoading}
                      activeOpacity={0.7}
                    >
                      <Text style={styles.primaryButtonText}>
                        {isLoading ? 'è™•ç†ä¸­...' : 'ä½¿ç”¨é‚€è«‹ç¢¼ï¼Œä¸€èµ·è³ºé»æ•¸ï¼'}
                      </Text>
                    </TouchableOpacity>
                    <TouchableOpacity
                      style={styles.textButton}
                      onPress={handleSkipInviteCode}
                      activeOpacity={0.7}
                    >
                      <Text style={styles.textButtonText}>ä¸ä½¿ç”¨é‚€è«‹ç¢¼</Text>
                    </TouchableOpacity>
                  </>
                ) : (
                  <TouchableOpacity
                    style={styles.outlineButton}
                    onPress={handleSkipInviteCode}
                    activeOpacity={0.7}
                  >
                    <Text style={styles.outlineButtonText}>æ²’æœ‰é‚€è«‹ç¢¼ï¼Œè·³éæ­¤æ­¥é©Ÿ</Text>
                  </TouchableOpacity>
                )}
              </View>
            </View>
          )}

          {/* Step 6: Welcome */}
          {step === 6 && (
            <View style={styles.card}>
              <View style={styles.stepHeader}>
                <View style={styles.welcomeIconCircle}>
                  <Ionicons
                    name={
                      userType === 'pedestrian'
                        ? 'person-outline'
                        : vehicleType === 'car'
                        ? 'car-outline'
                        : 'bicycle-outline'
                    }
                    size={32}
                    color={colors.primary.DEFAULT}
                  />
                </View>
                <Text style={styles.stepTitle}>
                  {userType === 'pedestrian' ? 'ğŸ™Œ æ­¡è¿åŠ å…¥ï¼' : 'ğŸš¦ æ­¡è¿ä¸Šè·¯ï¼'}
                </Text>
                <Text style={styles.stepSubtitle}>
                  {userType === 'pedestrian'
                    ? 'ä½ å¯ä»¥é–‹å§‹æé†’è·¯ä¸Šçš„æ±½è»Šèˆ‡æ©Ÿè»Š'
                    : 'æ¯å¤©éƒ½æœ‰ 2 é»å…è²»é¡åº¦ï¼Œç”¨ä¸€å€‹æ›´æ–‡æ˜çš„æ–¹å¼æé†’å½¼æ­¤'}
                </Text>
              </View>

              <Text style={styles.missionText}>
                æˆ‘å€‘ç›¸ä¿¡ï¼Œå¤šæ•¸äººä¸æ˜¯æ•…æ„çš„ï¼Œåªæ˜¯æ²’è¢«æé†’ã€‚
              </Text>

              {userType === 'pedestrian' && (
                <View style={styles.pedestrianInfoCard}>
                  <Text style={styles.pedestrianInfoItem}>âœ… å¯ä»¥ç™¼é€æé†’</Text>
                  <Text style={styles.pedestrianInfoItem}>âœ… æ¯å¤©å…è²» 2 é»</Text>
                  <Text style={styles.pedestrianInfoItemWarning}>âš ï¸ å› æ²’æœ‰è»Šç‰Œï¼Œç„¡æ³•æ¥æ”¶æé†’</Text>
                </View>
              )}

              {inviteCodeApplied && (
                <View style={styles.inviteAppliedCard}>
                  <Text style={styles.inviteAppliedText}>
                    ğŸ‰ å·²ä½¿ç”¨é‚€è«‹ç¢¼ï¼Œå®Œæˆè¨»å†Šå³å¯ç²å¾—çå‹µé»æ•¸
                  </Text>
                </View>
              )}

              <TouchableOpacity
                style={[styles.primaryButton, isLoading && styles.buttonDisabled]}
                onPress={handleCompleteOnboarding}
                disabled={isLoading}
                activeOpacity={0.7}
              >
                {isLoading ? (
                  <ActivityIndicator color={colors.primary.foreground} />
                ) : (
                  <Text style={styles.primaryButtonText}>é–‹å§‹ä½¿ç”¨</Text>
                )}
              </TouchableOpacity>
            </View>
          )}
        </ScrollView>
      </KeyboardAvoidingView>

      {/* License Plate Bound Dialog */}
      <Modal visible={showLicensePlateDialog} transparent animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>è»Šç‰Œå·²è¢«ç™»è¨˜</Text>
            <Text style={styles.modalDescription}>
              è©²è»Šç‰Œè™Ÿç¢¼ <Text style={styles.boldText}>{displayLicensePlate(licensePlate)}</Text> å·²è¢«ç¶å®šåˆ°æ‰‹æ©Ÿè™Ÿç¢¼{' '}
              <Text style={styles.boldText}>{licensePlateCheckResult?.boundPhone}</Text>
              {licensePlateCheckResult?.boundNickname && ` (${licensePlateCheckResult.boundNickname})`}ã€‚
              {'\n\n'}é€™æ˜¯å¦ç‚ºæ‚¨çš„è»Šè¼›ï¼Ÿ
            </Text>
            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={styles.modalSecondaryButton}
                onPress={() => {
                  setShowLicensePlateDialog(false);
                  setLicensePlate('');
                }}
                activeOpacity={0.7}
              >
                <Text style={styles.modalSecondaryButtonText}>ä¸æ˜¯ï¼Œé‡æ–°è¼¸å…¥</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={styles.modalPrimaryButton}
                onPress={handleConfirmApplication}
                activeOpacity={0.7}
              >
                <Text style={styles.modalPrimaryButtonText}>æ˜¯ï¼Œæäº¤ç”³è«‹</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* License Plate Application Dialog */}
      <Modal visible={showApplicationDialog} transparent animationType="fade">
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>æäº¤è»Šç‰Œç”³è«‹</Text>
            <Text style={styles.modalDescription}>
              è«‹æä¾› Email ä»¥æ¥æ”¶å¯©æ ¸é€šçŸ¥ï¼Œæˆ‘å€‘æœƒåœ¨ 1-2 å€‹å·¥ä½œå¤©å…§å¯©æ ¸ã€‚
            </Text>

            <View style={styles.applicationForm}>
              <Text style={styles.label}>Emailï¼ˆç”¨æ–¼æ¥æ”¶å¯©æ ¸é€šçŸ¥ï¼‰</Text>
              <TextInput
                style={styles.input}
                placeholder="è«‹è¼¸å…¥æ‚¨çš„ Email"
                placeholderTextColor={colors.muted.foreground}
                value={applicationEmail}
                onChangeText={setApplicationEmail}
                keyboardType="email-address"
                autoCapitalize="none"
              />

              <View style={styles.applicationInfo}>
                <Text style={styles.applicationInfoTitle}>ç”³è«‹è³‡è¨Š</Text>
                <Text style={styles.applicationInfoItem}>
                  è»Šç‰Œè™Ÿç¢¼ï¼š{displayLicensePlate(licensePlate)}
                </Text>
                <Text style={styles.applicationInfoItem}>
                  è»Šè¼›é¡å‹ï¼š{vehicleType === 'car' ? 'æ±½è»Š' : 'æ©Ÿè»Š'}
                </Text>
              </View>
            </View>

            <View style={styles.modalButtons}>
              <TouchableOpacity
                style={styles.modalSecondaryButton}
                onPress={() => setShowApplicationDialog(false)}
                activeOpacity={0.7}
              >
                <Text style={styles.modalSecondaryButtonText}>å–æ¶ˆ</Text>
              </TouchableOpacity>
              <TouchableOpacity
                style={[styles.modalPrimaryButton, isLoading && styles.buttonDisabled]}
                onPress={handleSubmitApplication}
                disabled={isLoading}
                activeOpacity={0.7}
              >
                <Text style={styles.modalPrimaryButtonText}>
                  {isLoading ? 'æäº¤ä¸­...' : 'æäº¤ç”³è«‹'}
                </Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  flex1: {
    flex: 1,
  },

  // Header - çµ±ä¸€æ ¼å¼ï¼ˆå›ºå®šé«˜åº¦ï¼‰
  headerContainer: {
    backgroundColor: colors.card.DEFAULT,
  },
  headerSafeArea: {
    backgroundColor: colors.card.DEFAULT,
  },
  header: {
    borderBottomWidth: 1,
    borderBottomColor: colors.borderSolid,
    paddingHorizontal: spacing[6],
    height: 52,
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  headerLeft: {
    width: 80,
    alignItems: 'flex-start',
    justifyContent: 'center',
    zIndex: 1,
  },
  headerRight: {
    width: 80,
  },
  backButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: spacing[2],
    paddingRight: spacing[4],
  },
  backText: {
    fontSize: typography.fontSize.sm,
    color: colors.muted.foreground,
    marginLeft: spacing[1],
  },
  headerTitle: {
    fontSize: typography.fontSize.base,
    fontWeight: typography.fontWeight.normal as any,
    color: colors.foreground,
    position: 'absolute',
    left: 0,
    right: 0,
    textAlign: 'center',
  },

  // Scroll Content
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    padding: spacing[6],
  },

  // Progress
  progressContainer: {
    flexDirection: 'row',
    justifyContent: 'center',
    gap: spacing[2],
    marginBottom: spacing[6],
  },
  progressDot: {
    width: 6,
    height: 6,
    borderRadius: 3,
    backgroundColor: colors.borderSolid,
  },
  progressDotActive: {
    width: 32,
    backgroundColor: colors.primary.DEFAULT,
  },
  progressDotCompleted: {
    backgroundColor: `${colors.primary.DEFAULT}40`,
  },

  // Card
  card: {
    backgroundColor: colors.card.DEFAULT,
    borderRadius: borderRadius.lg,
    padding: spacing[6],
    borderWidth: 1,
    borderColor: colors.borderSolid,
  },

  // Step Content
  stepContent: {
    gap: spacing[6],
  },
  stepHeader: {
    alignItems: 'center',
    marginBottom: spacing[4],
  },
  stepTitle: {
    fontSize: typography.fontSize.xl,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.foreground,
    marginBottom: spacing[2],
    textAlign: 'center',
  },
  stepSubtitle: {
    fontSize: typography.fontSize.sm,
    color: colors.muted.foreground,
    textAlign: 'center',
    lineHeight: typography.fontSize.sm * typography.lineHeight.relaxed,
  },

  // User Type Options (Step 1)
  userTypeOptions: {
    gap: spacing[3],
  },
  userTypeOption: {
    padding: spacing[5],
    borderWidth: 2,
    borderColor: colors.borderSolid,
    borderRadius: borderRadius['2xl'],
    backgroundColor: colors.card.DEFAULT,
  },
  userTypeContent: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing[4],
  },
  userTypeTextContainer: {
    flex: 1,
  },
  userTypeTitle: {
    fontSize: typography.fontSize.base,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.foreground,
    marginBottom: spacing[1],
  },
  userTypeDescription: {
    fontSize: typography.fontSize.xs,
    color: colors.muted.foreground,
  },

  // Info Card
  infoCard: {
    backgroundColor: colors.muted.DEFAULT,
    borderRadius: borderRadius.lg,
    padding: spacing[4],
  },
  infoText: {
    fontSize: typography.fontSize.xs,
    color: colors.muted.foreground,
    textAlign: 'center',
    lineHeight: typography.fontSize.xs * typography.lineHeight.relaxed,
  },

  // Icon Circle
  iconCircle: {
    width: 56,
    height: 56,
    borderRadius: 28,
    backgroundColor: `${colors.primary.DEFAULT}15`,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing[2],
  },

  // Reward Badge
  rewardBadge: {
    backgroundColor: `${colors.primary.DEFAULT}10`,
    paddingHorizontal: spacing[3],
    paddingVertical: spacing[1.5],
    borderRadius: 100,
    marginTop: spacing[2],
  },
  rewardBadgeText: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.primary.DEFAULT,
  },

  // Input Section
  inputSection: {
    gap: spacing[2],
  },
  label: {
    fontSize: typography.fontSize.sm,
    color: colors.foreground,
  },
  input: {
    borderWidth: 1,
    borderColor: colors.borderSolid,
    borderRadius: borderRadius.lg,
    paddingHorizontal: spacing[4],
    paddingVertical: spacing[3],
    fontSize: typography.fontSize.base,
    color: colors.foreground,
    backgroundColor: colors.card.DEFAULT,
  },
  inviteCodeInput: {
    borderWidth: 1,
    borderColor: colors.borderSolid,
    borderRadius: borderRadius.lg,
    paddingHorizontal: spacing[4],
    paddingVertical: spacing[4],
    fontSize: typography.fontSize.xl,
    textAlign: 'center',
    color: colors.foreground,
    backgroundColor: colors.card.DEFAULT,
  },
  licensePlateInput: {
    borderWidth: 1,
    borderColor: colors.borderSolid,
    borderRadius: borderRadius.lg,
    paddingHorizontal: spacing[4],
    paddingVertical: spacing[3.5],
    fontSize: typography.fontSize.lg,
    textAlign: 'center',
    color: colors.foreground,
    backgroundColor: colors.card.DEFAULT,
  },
  inputHint: {
    fontSize: typography.fontSize.xs,
    color: colors.muted.foreground,
  },
  inputHintCenter: {
    fontSize: typography.fontSize.xs,
    color: colors.muted.foreground,
    textAlign: 'center',
  },

  // Validation
  validatingText: {
    fontSize: typography.fontSize.xs,
    color: colors.muted.foreground,
    textAlign: 'center',
  },
  validCodeCard: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing[3],
    padding: spacing[3],
    backgroundColor: '#F0FDF4',
    borderWidth: 1,
    borderColor: '#BBF7D0',
    borderRadius: borderRadius.lg,
  },
  validCodeIcon: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: '#DCFCE7',
    alignItems: 'center',
    justifyContent: 'center',
  },
  validCodeContent: {
    flex: 1,
  },
  validCodeTitle: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: '#166534',
  },
  validCodeSubtitle: {
    fontSize: typography.fontSize.xs,
    color: '#16A34A',
  },
  invalidCodeText: {
    fontSize: typography.fontSize.xs,
    color: '#DC2626',
    textAlign: 'center',
  },

  // Buttons
  buttonGroup: {
    gap: spacing[2],
    marginTop: spacing[4],
  },
  primaryButton: {
    backgroundColor: colors.primary.DEFAULT,
    borderRadius: borderRadius.xl,
    paddingVertical: spacing[3.5],
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 48,
  },
  primaryButtonText: {
    color: colors.primary.foreground,
    fontSize: typography.fontSize.base,
    fontWeight: typography.fontWeight.medium as any,
  },
  outlineButton: {
    borderWidth: 1,
    borderColor: colors.borderSolid,
    borderRadius: borderRadius.xl,
    paddingVertical: spacing[3],
    alignItems: 'center',
  },
  outlineButtonText: {
    color: colors.foreground,
    fontSize: typography.fontSize.base,
  },
  textButton: {
    paddingVertical: spacing[2],
    alignItems: 'center',
  },
  textButtonText: {
    color: colors.muted.foreground,
    fontSize: typography.fontSize.sm,
  },
  buttonDisabled: {
    opacity: 0.5,
  },
  buttonMarginTop: {
    marginTop: spacing[4],
  },

  // Vehicle Type Badge
  vehicleTypeBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing[2],
    marginBottom: spacing[4],
  },
  vehicleTypeBadgeText: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.primary.DEFAULT,
  },

  // Points Info (Step 4)
  pointsInfoList: {
    backgroundColor: colors.muted.DEFAULT,
    borderRadius: borderRadius.lg,
    padding: spacing[4],
    gap: spacing[2],
    marginBottom: spacing[4],
  },
  pointsInfoItem: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: spacing[3],
  },
  pointsInfoIcon: {
    fontSize: typography.fontSize.sm,
  },
  pointsInfoText: {
    flex: 1,
    fontSize: typography.fontSize.sm,
    color: colors.foreground,
  },
  bonusCard: {
    backgroundColor: `${colors.primary.DEFAULT}08`,
    borderWidth: 2,
    borderColor: `${colors.primary.DEFAULT}30`,
    borderRadius: borderRadius.lg,
    padding: spacing[4],
    marginBottom: spacing[4],
  },
  bonusCardText: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.primary.dark,
    textAlign: 'center',
  },

  // Welcome (Step 6)
  welcomeIconCircle: {
    width: 64,
    height: 64,
    borderRadius: 32,
    backgroundColor: `${colors.primary.DEFAULT}10`,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing[4],
  },
  missionText: {
    fontSize: typography.fontSize.xs,
    color: colors.muted.foreground,
    textAlign: 'center',
    fontStyle: 'italic',
    marginBottom: spacing[4],
  },
  pedestrianInfoCard: {
    backgroundColor: colors.muted.DEFAULT,
    borderWidth: 1,
    borderColor: colors.borderSolid,
    borderRadius: borderRadius.lg,
    padding: spacing[4],
    gap: spacing[1],
    marginBottom: spacing[4],
  },
  pedestrianInfoItem: {
    fontSize: typography.fontSize.xs,
    color: colors.foreground,
  },
  pedestrianInfoItemWarning: {
    fontSize: typography.fontSize.xs,
    color: colors.foreground,
  },
  inviteAppliedCard: {
    backgroundColor: '#F0FDF4',
    borderWidth: 1,
    borderColor: '#BBF7D0',
    borderRadius: borderRadius.lg,
    padding: spacing[4],
    marginBottom: spacing[4],
  },
  inviteAppliedText: {
    fontSize: typography.fontSize.sm,
    color: '#166534',
    textAlign: 'center',
  },

  // Modal
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing[6],
  },
  modalContent: {
    backgroundColor: colors.card.DEFAULT,
    borderRadius: borderRadius.lg,
    padding: spacing[6],
    width: '100%',
    maxWidth: 400,
  },
  modalTitle: {
    fontSize: typography.fontSize.lg,
    fontWeight: typography.fontWeight.semibold as any,
    color: colors.foreground,
    marginBottom: spacing[2],
  },
  modalDescription: {
    fontSize: typography.fontSize.sm,
    color: colors.muted.foreground,
    lineHeight: typography.fontSize.sm * typography.lineHeight.relaxed,
    marginBottom: spacing[4],
  },
  boldText: {
    fontWeight: typography.fontWeight.semibold as any,
    color: colors.foreground,
  },
  modalButtons: {
    flexDirection: 'row',
    gap: spacing[3],
  },
  modalSecondaryButton: {
    flex: 1,
    backgroundColor: colors.muted.DEFAULT,
    borderRadius: borderRadius.lg,
    paddingVertical: spacing[3],
    alignItems: 'center',
  },
  modalSecondaryButtonText: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.foreground,
  },
  modalPrimaryButton: {
    flex: 1,
    backgroundColor: colors.primary.DEFAULT,
    borderRadius: borderRadius.lg,
    paddingVertical: spacing[3],
    alignItems: 'center',
  },
  modalPrimaryButtonText: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.primary.foreground,
  },

  // Application Form
  applicationForm: {
    gap: spacing[3],
    marginBottom: spacing[4],
  },
  applicationInfo: {
    backgroundColor: colors.muted.DEFAULT,
    borderRadius: borderRadius.lg,
    padding: spacing[4],
  },
  applicationInfoTitle: {
    fontSize: typography.fontSize.sm,
    fontWeight: typography.fontWeight.medium as any,
    color: colors.foreground,
    marginBottom: spacing[2],
  },
  applicationInfoItem: {
    fontSize: typography.fontSize.sm,
    color: colors.muted.foreground,
  },
});
