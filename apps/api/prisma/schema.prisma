// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

// Seed configuration
// Run: npm run prisma:seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  driver
  pedestrian
}

enum VehicleType {
  car
  scooter
}

enum MessageType {
  VEHICLE_REMINDER // è»Šæ³æé†’
  SAFETY_REMINDER // è¡Œè»Šå®‰å…¨æé†’
  PRAISE // è®šç¾æ„Ÿè¬
}

enum PointHistoryType {
  recharge
  spend
  earn
  bonus
}

enum InviteStatus {
  pending   // é‚€è«‹ç¢¼å·²è¼¸å…¥ï¼Œonboarding æœªå®Œæˆ
  completed // onboarding å®Œæˆï¼Œçå‹µå·²ç™¼æ”¾
  expired   // ç”¨æˆ¶æ”¾æ£„è¨»å†Š
}

enum ApplicationStatus {
  pending // å¾…å¯©æ ¸
  approved // å·²é€šé
  rejected // å·²æ‹’çµ•
}

enum ReportStatus {
  pending // å¾…å¯©æ ¸
  reviewed // å·²å¯©æ ¸
  resolved // å·²è™•ç†
}

model User {
  id                     String       @id @default(cuid())
  phone                  String?      @unique // æ”¹ç‚ºå¯é¸ï¼Œæ”¯æ´ LINE ç™»å…¥ç”¨æˆ¶
  password               String? // å¯†ç¢¼ï¼ˆå¯é¸ï¼Œç”¨æ–¼å·²è¨»å†Šç”¨æˆ¶ï¼‰
  nickname               String?
  licensePlate           String?
  userType               UserType
  vehicleType            VehicleType?
  points                 Int          @default(0)  // è³¼è²·/é‚€è«‹çå‹µé»æ•¸ï¼ˆæ°¸ä¹…ç´¯ç©ï¼Œä¸æœƒé‡ç½®ï¼‰
  freePoints             Int          @default(0)  // æ¯æ—¥å…è²»é»æ•¸ï¼ˆè©¦ç”¨çµæŸå¾Œæ¯æ—¥é‡ç½®ç‚º2ï¼‰
  trialPoints            Int          @default(0)  // è©¦ç”¨æœŸé»æ•¸ï¼ˆä¸€æ¬¡æ€§ç™¼æ”¾ï¼Œç”¨å®Œä¸è£œï¼‰
  lastFreePointsReset    DateTime?                 // ä¸Šæ¬¡å…è²»é»æ•¸é‡ç½®æ™‚é–“ï¼ˆå°åŒ—æ™‚é–“ï¼‰
  hasCompletedOnboarding Boolean      @default(false)
  email                  String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  // LINE Login ç›¸é—œæ¬„ä½
  lineUserId             String?      @unique // LINE User ID
  lineDisplayName        String?              // LINE é¡¯ç¤ºåç¨±
  linePictureUrl         String?              // LINE é ­åƒ URL
  isLineFriend           Boolean      @default(false) // æ˜¯å¦å·²åŠ å…¥ LINE å®˜æ–¹å¸³è™Ÿå¥½å‹

  // Apple Sign-In ç›¸é—œæ¬„ä½
  appleUserId            String?      @unique // Apple User ID (sub claim from identity token)
  appleEmail             String?              // Apple æä¾›çš„ emailï¼ˆå¯èƒ½æ˜¯ private relayï¼‰

  // å®˜æ–¹å°é–ç›¸é—œæ¬„ä½
  isBlockedByAdmin       Boolean      @default(false) // æ˜¯å¦è¢«å®˜æ–¹å°é–
  blockedByAdminAt       DateTime?                    // å°é–æ™‚é–“
  blockedByAdminReason   String?                      // å°é–åŸå› 

  // è©¦ç”¨æœŸç›¸é—œ
  trialStartDate         DateTime?                    // è©¦ç”¨é–‹å§‹æ—¥æœŸï¼ˆè¨»å†Šå®Œæˆæ™‚è¨­å®šï¼‰
  trialEndedProcessed    Boolean      @default(false) // æ˜¯å¦å·²è™•ç†è©¦ç”¨çµæŸï¼ˆé»æ•¸æ­¸é›¶ã€ç™¼æ”¾ä¸€æ¬¡æ€§çå‹µï¼‰

  // é‚€è«‹ç¢¼ç›¸é—œ
  inviteCode             String?      @unique        // ç”¨æˆ¶çš„å€‹äººé‚€è«‹ç¢¼
  invitedById            String?                     // é‚€è«‹æ­¤ç”¨æˆ¶çš„äººçš„ ID
  invitedBy              User?        @relation("Inviter", fields: [invitedById], references: [id])
  invitedUsers           User[]       @relation("Inviter")
  customInviterReward    Int?                        // æ­¤ç”¨æˆ¶çš„é‚€è«‹ç¢¼çµ¦é‚€è«‹äººçš„çå‹µï¼ˆè¦†è“‹é è¨­ï¼‰
  customInviteeReward    Int?                        // æ­¤ç”¨æˆ¶çš„é‚€è«‹ç¢¼çµ¦è¢«é‚€è«‹äººçš„çå‹µï¼ˆè¦†è“‹é è¨­ï¼‰

  // Relations
  sentMessages             Message[]                 @relation("Sender")
  receivedMessages         Message[]                 @relation("Receiver")
  pointHistory             PointHistory[]
  blockedUsers             BlockedUser[]             @relation("Blocker")
  blockedByUsers           BlockedUser[]             @relation("Blocked")
  rejectedUsers            RejectedUser[]            @relation("Rejecter")
  rejectedByUsers          RejectedUser[]            @relation("Rejected")
  messageReports           MessageReport[]           @relation("Reporter")
  aiUsageLogs              AIUsageLog[]
  licensePlateApplications LicensePlateApplication[]
  inviteHistoryAsInviter   InviteHistory[]           @relation("InviterHistory")
  inviteHistoryAsInvitee   InviteHistory?            @relation("InviteeHistory")
  deviceTokens             DeviceToken[]
  voiceDrafts              VoiceDraft[]
  activities               UserActivity[]
  savedPlates              SavedPlate[]

  @@index([phone])
  @@index([licensePlate])
  @@index([lineUserId])
  @@index([appleUserId])
}

model Message {
  id         String      @id @default(cuid())
  type       MessageType
  template   String
  customText String?
  replyText    String?   // æ¥æ”¶è€…å›è¦†å…§å®¹
  replyReadAt  DateTime? // ç™¼é€è€…å·²è®€å›è¦†çš„æ™‚é–“
  location     String?   // äº‹ç™¼åœ°é»ï¼ˆåœ°å€æˆ–æè¿°ï¼‰
  occurredAt DateTime?   // äº‹ç™¼æ™‚é–“
  read       Boolean     @default(false)
  createdAt  DateTime    @default(now())

  // èªéŸ³è¨Šæ¯ç›¸é—œ
  voiceUrl      String?   // èªéŸ³æª”æ¡ˆ URLï¼ˆR2 å„²å­˜ï¼‰
  voiceDuration Int?      // èªéŸ³é•·åº¦ï¼ˆç§’ï¼‰
  hasVoice      Boolean   @default(false) // æ˜¯å¦ç‚ºèªéŸ³è¨Šæ¯

  // Relations
  senderId   String
  sender     User            @relation("Sender", fields: [senderId], references: [id])
  receiverId String
  receiver   User            @relation("Receiver", fields: [receiverId], references: [id])
  reports    MessageReport[] // æª¢èˆ‰è¨˜éŒ„

  @@index([receiverId, createdAt])
  @@index([senderId])
}

model PointHistory {
  id          String           @id @default(cuid())
  type        PointHistoryType
  amount      Int
  description String
  createdAt   DateTime         @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model BlockedUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  blockerId String
  blocker   User   @relation("Blocker", fields: [blockerId], references: [id])
  blockedId String
  blocked   User   @relation("Blocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model RejectedUser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  rejecterId String
  rejecter   User   @relation("Rejecter", fields: [rejecterId], references: [id])
  rejectedId String
  rejected   User   @relation("Rejected", fields: [rejectedId], references: [id])

  @@unique([rejecterId, rejectedId])
  @@index([rejecterId])
  @@index([rejectedId])
}

model AIUsageLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  usedAt    DateTime @default(now())
  resetDate DateTime // ç”¨æ–¼è¿½è¹¤æ¯æ—¥é‡ç½®

  @@index([userId, resetDate])
  @@index([resetDate])
}

model LicensePlateApplication {
  id           String            @id @default(cuid())
  userId       String
  user         User              @relation(fields: [userId], references: [id])
  licensePlate String
  vehicleType  VehicleType?
  status       ApplicationStatus @default(pending)
  licenseImage String? // è¡Œç…§ç…§ç‰‡ URL
  email        String? // ç”³è«‹äºº Emailï¼ˆç”¨æ–¼é€šçŸ¥å¯©æ ¸çµæœï¼‰
  adminNote    String? // ç®¡ç†å“¡å‚™è¨»
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  reviewedAt   DateTime?
  reviewedBy   String? // å¯©æ ¸ç®¡ç†å“¡ ID

  @@index([userId])
  @@index([licensePlate])
  @@index([status])
}

model MessageReport {
  id         String       @id @default(cuid())
  messageId  String
  message    Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User         @relation("Reporter", fields: [reporterId], references: [id])
  reason     String? // æª¢èˆ‰åŸå› 
  status     ReportStatus @default(pending)
  adminNote  String? // ç®¡ç†å“¡å‚™è¨»
  createdAt  DateTime     @default(now())
  reviewedAt DateTime?
  reviewedBy String? // å¯©æ ¸ç®¡ç†å“¡ ID

  @@unique([messageId, reporterId]) // åŒä¸€ç”¨æˆ¶å°åŒä¸€è¨Šæ¯åªèƒ½æª¢èˆ‰ä¸€æ¬¡
  @@index([messageId])
  @@index([reporterId])
  @@index([status])
}

model AIPrompt {
  id          String      @id @default(cuid())
  vehicleType VehicleType // car | scooter
  category    String // 'è»Šæ³æé†’' | 'è¡Œè»Šå®‰å…¨' | 'è®šç¾æ„Ÿè¬' | 'å…¶ä»–æƒ…æ³'
  prompt      String // Prompt æ¨¡æ¿ï¼Œå¯ä»¥ä½¿ç”¨ {text} å ä½ç¬¦
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([vehicleType, category])
  @@index([vehicleType, category, isActive])
}

model InviteSettings {
  id                   String   @id @default(cuid())
  defaultInviterReward Int      @default(5)    // é‚€è«‹äººçå‹µé»æ•¸
  defaultInviteeReward Int      @default(3)    // è¢«é‚€è«‹äººçå‹µé»æ•¸
  isEnabled            Boolean  @default(true) // å•Ÿç”¨/åœç”¨é‚€è«‹ç³»çµ±
  updatedAt            DateTime @updatedAt
}

// æ‡‰ç”¨ç¨‹å¼å…§å®¹è¨­å®šï¼ˆLanding Pageã€é¦–é æ¨™é¡Œç­‰ï¼‰
model AppContent {
  id                String   @id @default(cuid())
  landingTagline    String   @default("è®“è·¯ä¸Šå¤šä¸€é»å–„æ„ ğŸ’™")
  landingSubtext    String   @default("é€éè»Šç‰Œç™¼é€å–„æ„æé†’\nè®“æ¯ä¸€ä½é§•é§›æ›´å®‰å…¨")
  homeHeroTitle     String   @default("è®“è·¯ä¸Šå¤šä¸€é»å–„æ„ ğŸ’™")
  homeHeroSubtitle  String   @default("é€éè»Šç‰Œç™¼é€å–„æ„æé†’ï¼Œè®“é§•é§›æ›´å®‰å…¨")
  updatedAt         DateTime @updatedAt
}

model InviteHistory {
  id            String       @id @default(cuid())
  inviterId     String
  inviter       User         @relation("InviterHistory", fields: [inviterId], references: [id])
  inviteeId     String       @unique  // æ¯å€‹ç”¨æˆ¶åªèƒ½è¢«é‚€è«‹ä¸€æ¬¡
  invitee       User         @relation("InviteeHistory", fields: [inviteeId], references: [id])
  inviteCode    String       // ä½¿ç”¨çš„é‚€è«‹ç¢¼
  status        InviteStatus @default(pending)
  inviterReward Int          // å¯¦éš›çµ¦é‚€è«‹äººçš„çå‹µ
  inviteeReward Int          // å¯¦éš›çµ¦è¢«é‚€è«‹äººçš„çå‹µ
  rewardedAt    DateTime?    // çå‹µç™¼æ”¾æ™‚é–“
  createdAt     DateTime     @default(now())

  @@index([inviterId])
  @@index([status])
  @@index([createdAt])
}

// æ¨æ’­é€šçŸ¥ç›¸é—œ

enum DevicePlatform {
  ios
  android
}

model DeviceToken {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String         // Expo Push Token (ExponentPushToken[xxx])
  platform  DevicePlatform
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@unique([userId, token])
  @@index([userId])
  @@index([token])
  @@index([isActive])
}

enum NotificationType {
  message     // æ”¶åˆ°æ–°æé†’
  reply       // æ”¶åˆ°å›è¦†
  broadcast   // ç®¡ç†å“¡æ¨æ’­
  system      // ç³»çµ±é€šçŸ¥
}

model NotificationLog {
  id             String           @id @default(cuid())
  type           NotificationType
  title          String
  body           String
  data           Json?            // é¡å¤–è³‡æ–™ï¼ˆå¦‚ messageIdï¼‰
  targetUserIds  String[]         // ç›®æ¨™ç”¨æˆ¶ ID åˆ—è¡¨ï¼ˆç©ºé™£åˆ—è¡¨ç¤ºå…¨é«”ç”¨æˆ¶ï¼‰
  successCount   Int              @default(0)
  failureCount   Int              @default(0)
  sentBy         String?          // ç™¼é€è€…ï¼ˆadmin ID æˆ– systemï¼‰
  createdAt      DateTime         @default(now())

  @@index([type])
  @@index([createdAt])
}

// ============ èªéŸ³è‰ç¨¿åŠŸèƒ½ ============

enum DraftStatus {
  PENDING     // ç­‰å¾…è™•ç†
  PROCESSING  // AI è™•ç†ä¸­
  READY       // è™•ç†å®Œæˆï¼Œå¯ç™¼é€
  SENT        // å·²ç™¼é€
  EXPIRED     // å·²éæœŸ
  DELETED     // å·²åˆªé™¤
}

model VoiceDraft {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // èªéŸ³æª”æ¡ˆ
  voiceUrl        String      // R2 URL
  voiceDuration   Int         // ç§’æ•¸
  transcript      String?     // èªéŸ³è½‰æ–‡å­—çµæœ

  // AI è§£æçµæœ
  parsedPlates    String[]    // å€™é¸è»Šç‰Œ ["ABC-1234", "ABC-1235"]
  parsedVehicle   Json?       // { type: "car", color: "ç™½è‰²", brand: "Toyota", model: "Camry" }
  parsedEvent     Json?       // { type: "dangerous_driving", category: "SAFETY_REMINDER", description: "å±éšªåˆ‡æ›è»Šé“" }
  suggestedMessage String?    // AI å»ºè­°çš„è¨Šæ¯

  // ç”¨æˆ¶è¼¸å…¥è³‡æ–™ï¼ˆèªéŸ³æé†’é é¢å¡«å¯«ï¼‰
  selectedPlate   String?     // ç”¨æˆ¶é¸æ“‡/è¼¸å…¥çš„è»Šç‰Œ
  vehicleType     String?     // car | scooter
  occurredAt      DateTime?   // éŒ„è£½/äº‹ç™¼æ™‚é–“

  // ä½ç½®ï¼ˆéŒ„éŸ³æ™‚è‡ªå‹•è¨˜éŒ„ï¼‰
  latitude        Float?
  longitude       Float?
  address         String?

  // ç‹€æ…‹
  status          DraftStatus @default(PENDING)
  expiresAt       DateTime    // 24å°æ™‚å¾ŒéæœŸ

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId, status])
  @@index([status, expiresAt])
}

// ============ IAP äº¤æ˜“è¨˜éŒ„ ============

enum IAPPlatform {
  ios
  android
}

model IAPTransaction {
  id              String      @id @default(cuid())
  userId          String
  transactionId   String      @unique  // Apple/Google çš„äº¤æ˜“ IDï¼Œé˜²æ­¢é‡è¤‡è™•ç†
  platform        IAPPlatform
  productId       String                // ç”¢å“ ID (e.g., com.ubeep.mobile.points_15)
  pointsAwarded   Int                   // å¯¦éš›ç™¼æ”¾çš„é»æ•¸
  receiptData     String?     @db.Text  // åŸå§‹æ”¶æ“šæ•¸æ“šï¼ˆç”¨æ–¼å¯©è¨ˆï¼‰
  environment     String?               // sandbox æˆ– production
  verifiedAt      DateTime    @default(now())

  @@index([userId])
  @@index([transactionId])
  @@index([verifiedAt])
}

// ============ ç”¨æˆ¶è¡Œç‚ºè¿½è¹¤ ============

enum ActivityType {
  RECORDING_COMPLETE   // éŒ„éŸ³å®Œæˆ
  TEXT_EDIT            // æ–‡å­—ç·¨è¼¯ï¼ˆé»æ“Šä¸‹ä¸€æ­¥ï¼‰
  AI_OPTIMIZE          // AI å„ªåŒ–
  MESSAGE_SENT         // è¨Šæ¯ç™¼é€æˆåŠŸ
  RECORDING_CANCEL     // å–æ¶ˆéŒ„éŸ³
}

model UserActivity {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  type            ActivityType // æ´»å‹•é¡å‹

  // å…§å®¹è³‡è¨Š
  messageText     String?      @db.Text  // è¨Šæ¯æ–‡å­—å…§å®¹
  voiceUrl        String?      // èªéŸ³æª”æ¡ˆ URL
  voiceDuration   Int?         // èªéŸ³é•·åº¦ï¼ˆç§’ï¼‰
  transcript      String?      @db.Text  // èªéŸ³è½‰æ–‡å­—çµæœ

  // AI å¯©æ ¸çµæœ
  aiModerationResult Json?     // { isAppropriate, reason, category }

  // ç›®æ¨™è³‡è¨Š
  targetPlate     String?      // ç›®æ¨™è»Šç‰Œ
  vehicleType     String?      // car | scooter
  category        String?      // è»Šæ³æé†’ | è¡Œè»Šå®‰å…¨ | è®šç¾æ„Ÿè¬

  // ç™¼é€æ¨¡å¼
  sendMode        String?      // template | text | voice | ai

  // ä½ç½®è³‡è¨Š
  latitude        Float?
  longitude       Float?
  location        String?

  // é¡å¤–è³‡æ–™
  metadata        Json?        // å…¶ä»–å½ˆæ€§è³‡æ–™

  // æ˜¯å¦æœ€çµ‚ç™¼é€
  isSent          Boolean      @default(false)
  messageId       String?      // é—œè¯çš„è¨Šæ¯ IDï¼ˆå¦‚æœæœ‰ç™¼é€ï¼‰

  createdAt       DateTime     @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([isSent])
}

// ============ è»Šç‰Œæ”¶è—åŠŸèƒ½ ============

model SavedPlate {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  licensePlate String
  nickname     String
  vehicleType  VehicleType @default(car)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@unique([userId, licensePlate])
  @@index([userId])
}
